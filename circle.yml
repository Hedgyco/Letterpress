machine:

  pre:
    # Install NVM (Node version manager)
    - curl https://raw.githubusercontent.com/creationix/nvm/v0.24.1/install.sh | bash

  node:
    version: 0.10.36

  java:
    version: oraclejdk8

  environment:
    VELOCITY_CI: true
    # Enable this line to run Velocity and test frameworks in debug mode
    VELOCITY_DEBUG: true
    CUCUMBER_SCREENSHOTS_DIR: "$CIRCLE_ARTIFACTS/screenshots"
    CUCUMBER_JSON_OUTPUT: "$CIRCLE_TEST_REPORTS/results.cucumber"

dependencies:
#  cache_directories:
#    - "~/.meteor"
#    - "~/.npm"

  # Everything that should be cached must be installed here
  override:
    # Remove the CircleCI chromedrivers
    - sudo rm -rf /usr/local/bin/chromedriver*
    # Restore meteor symlink when Meteor was restored from the cache
    - if [ -d ~/.meteor ]; then sudo ln -s ~/.meteor/meteor /usr/local/bin/meteor; fi
    # Download Meteor if isn't already installed via the cache
    - if [ ! -e $HOME/.meteor/meteor ]; then curl https://install.meteor.com | sh; fi
    # Download Cucumber support files dependencies
    - npm install --production:
        pwd: tests/cucumber

test:
  override:
    # Start Meteor app
    - meteor --test:
        environment:
          SELENIUM_BROWSER: firefox
    - cp .meteor/local/log/*.log $CIRCLE_ARTIFACTS
